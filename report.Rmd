---
params:
  report_title: "Explore similar pages, categories and suggested languages in search results"
  phab_ticket: "T149809"
  test_description: >
    This A/B test will have a test group that will be shown additional
    information that will be relevant to individual results on the existing
    search results page. This additional information will be links and
    metadata of related pages with links to related categories and suggested
    language links that are similar to the individual search results. A
    control group will see the currently existing search results page.
  data: "./data/Explore similar pages, categories and suggested languages in search results/events_raw_20170724112938.RData"
  start_date: 20170713 # inclusive
  end_date: 20170723 # exclusive
  tss2_revision: 16909631
  wiki: enwiki
  test_group_names: [explore_similar_control, explore_similar_test]
  event_action: [searchResultPage, click, ssclick, visitPage, checkin, hover-on, hover-off, esclick]
  event_source: "fulltext"
  other_filter: "event_subTest IS NOT NULL"
  debug: true # setting to false hides messages and warnings
title: '`r params$report_title`'
author: '`r paste("Generated by", ifelse(params$debug, Sys.info()["user"], "the automated A/B test reporting tool"))`'
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  html_document:
    # Table of Contents
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    code_folding: hide
    # Figures
    fig_width: 10
    fig_height: 6
    # Theme
    theme: flatly
    highlight: zenburn
    # Files
    self_contained: false
    keep_md: true
    # Extras
    mathjax: https://tools-static.wmflabs.org/cdnjs/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML
    md_extensions: +raw_html +markdown_in_html_blocks +tex_math_dollars +fancy_lists +startnum +lists_without_preceding_blankline -autolink_bare_uris
---
```{js, echo=FALSE}
$( function() {
  /* Lets the user click on the images to view them in full resolution. */
  $( "img" ).wrap( function() {
    var link = $( '<a/>' );
    link.attr( 'href', $( this ).attr( 'src' ));
    link.attr( 'target', '_blank' );
    return link;
  } );
} );
```
```{css, echo=FALSE}
/* Differentiate sub-tabs from tabs by using its complement */
div.tab-content a[role=tab] {
  color: #BC1838;
}
```
```{r setup, echo=TRUE, error=TRUE, message=params$debug, warning=params$debug}
############## Read parameters for debugging ################
if (length(rmarkdown::metadata) == 0) {
  params <- rmarkdown::yaml_front_matter("report.Rmd")$params
}
#############################################################
knitr::opts_chunk$set(
  error = TRUE, message = params$debug, warning = params$debug
)
set.seed(0)
suppressPackageStartupMessages({
  library(magrittr)
  library(ggplot2)
  import::from(
    # We don't import certain verbs (e.g. distinct, left_join, bind_rows)
    # to avoid potential name-conflicts and because they're one-time use.
    dplyr,
    # Subsetting Verbs
    keep_where = filter, select,
    # Grouping Verbs
    group_by, ungroup,
    # Manipulation Verbs
    mutate, arrange, summarize, tally,
    # Utility Functions
    case_when, if_else
  )
})
source("functions.R")
```

`r if (!is.null(params$test_description)) { params$test_description }`

This test ran from `r format(lubridate::ymd(params$start_date), "%d %B %Y")` to `r format(lubridate::ymd(params$end_date) - 1, "%d %B %Y")` on `r ifelse(is.null(params$wiki), "all wikis", paste(params$wiki, collapse = ", "))`. There were `r length(params$test_group_names)` test groups: `r paste(params$test_group_names, collapse = ", ")`. This report includes `r paste(params$event_source, collapse = ", ")` searches. Refer to Phabricator ticket [`r params$phab_ticket`](`r paste0("https://phabricator.wikimedia.org/", params$phab_ticket)`) for more details.

```{r sql_setup, echo=FALSE}
is_stat_machine <- grepl("^stat1", Sys.info()["nodename"])
if (!is_stat_machine & is.null(params$data)) {
  message("Create an auto-closing SSH tunnel in the background...")
  # See https://gist.github.com/scy/6781836 for more info.
  system("ssh -f -o ExitOnForwardFailure=yes stat1003.eqiad.wmnet -L 3307:analytics-store.eqiad.wmnet:3306 sleep 10")
  library(RMySQL)
  con <- dbConnect(MySQL(), host = "127.0.0.1", group = "client", dbname = "log", port = 3307)
}
```

```{r fetch_data, echo=FALSE, results='asis'}
query <- paste0("SELECT
  timestamp,
  event_uniqueId AS event_id,
  event_mwSessionId,
  event_pageViewId AS page_id,
  event_searchSessionId AS session_id,
  event_subTest AS `group`,
  wiki,
  MD5(LOWER(TRIM(event_query))) AS query_hash,
  event_action AS event,
  CASE
    WHEN event_position < 0 THEN NULL
    ELSE event_position
    END AS event_position,
  CASE
    WHEN event_action = 'searchResultPage' AND event_hitsReturned > 0 THEN 'TRUE'
    WHEN event_action = 'searchResultPage' AND event_hitsReturned IS NULL THEN 'FALSE'
    ELSE NULL
    END AS `some same-wiki results`,
  CASE
    WHEN event_action = 'searchResultPage' AND event_hitsReturned > -1 THEN event_hitsReturned
    WHEN event_action = 'searchResultPage' AND event_hitsReturned IS NULL THEN 0
    ELSE NULL
    END AS n_results,
  event_scroll,
  event_checkin,
  event_extraParams,
  event_msToDisplayResults AS load_time,
  event_searchToken AS search_token,
  userAgent AS user_agent
FROM TestSearchSatisfaction2_", params$tss2_revision, "\n",
"WHERE LEFT(timestamp, 8) >= '", params$start_date, "' AND LEFT(timestamp, 8) < '", params$end_date, "' \n",
ifelse(is.null(params$wiki), "", paste0("  AND wiki IN('", paste(params$wiki, collapse = "', '"), "') \n")),
ifelse(is.null(params$`test_group_names`), "", paste0("  AND event_subTest IN('", paste(params$`test_group_names`, collapse = "', '"), "') \n")),
ifelse(is.null(params$event_action), "", paste0("  AND event_action IN('", paste(params$event_action, collapse = "', '"), "') \n")),
ifelse(is.null(params$event_source), "", paste0("  AND event_source IN('", paste(params$event_source, collapse = "', '"), "') \n")),
ifelse(is.null(params$other_filter), "", paste0("  AND ", params$other_filter, " \n")),
"  AND CASE WHEN event_action = 'searchResultPage' THEN event_msToDisplayResults IS NOT NULL
            WHEN event_action IN ('click', 'iwclick', 'ssclick') THEN event_position IS NOT NULL AND event_position > -1
            WHEN event_action = 'visitPage' THEN event_pageViewId IS NOT NULL
            WHEN event_action = 'checkin' THEN event_checkin IS NOT NULL AND event_pageViewId IS NOT NULL
            ELSE TRUE
       END;"
)

if (!is.null(params$query)) {
  message("Using user-supplied query instead of built-in query...")
  query <- params$query
}

if (is.null(params$data)) {

  message("User did not provide data. Fetching data using query...")
  if (is_stat_machine) {
    message("(Running on a stat machine.)")
    events_raw <- wmf::mysql_read(query, "log")
  } else {
    message("Using SSH tunnel & connection to Analytics-Store...")
    events_raw <- wmf::mysql_read(query, "log", con = con)
    message("Closing connection...")
    wmf::mysql_close(con)
  }

  if (!dir.exists(file.path("data", gsub(.Platform$file.sep, "", params$report_title)))) {
    message("Data directory does not exist; creating one...")
    dir.create(file.path("data", gsub(.Platform$file.sep, "", params$report_title)), recursive = TRUE)
  }

  message("Saving raw events data...")
  save(events_raw, file = file.path("data", gsub(.Platform$file.sep, "", params$report_title), paste0("events_raw_", gsub("[^0-9]", "", Sys.time()), ".RData")))

  cat("**Query**:\n\n```SQL\n", query, "\n```\n")

} else {

  if (tools::file_ext(params$data) == "RData") {
    load(params$data)
  } else{
    events_raw <- data.table::fread(input = params$data, data.table = FALSE)
  }

}
```

## Data Clean-up

```{r data_cleansing, echo=FALSE, results='asis'}
if (exists("events_raw")) {
  events <- events_raw
}

message("De-duplicating events...")
events <- events %>%
  mutate(
    timestamp = lubridate::ymd_hms(timestamp),
    date = as.Date(timestamp)
  ) %>%
  arrange(session_id, event_id, timestamp) %>%
  dplyr::distinct(session_id, event_id, .keep_all = TRUE)
cat("Deleted ", nrow(events_raw) - nrow(events), " duplicated events.")
rm(events_raw) # to free up memory

message("De-duplicating SERPs...")
SERPs <- events %>%
  keep_where(event == "searchResultPage") %>%
  select(c(session_id, page_id, query_hash, search_token)) %>%
  group_by(session_id, query_hash) %>%
  mutate(serp_id = page_id[1], cirrus_id = search_token[1]) %>%
  ungroup %>%
  select(c(page_id, serp_id, cirrus_id))
events <- events %>%
  dplyr::left_join(SERPs, by = "page_id")
rm(SERPs) # to free up memory

message("Removing events without an associated SERP (orphan clicks and check-ins)...")
n_evnt <- nrow(events)
events <- events %>%
  keep_where(!(is.na(serp_id) & !(event %in% c("visitPage", "checkin")))) %>% # remove orphan click
  group_by(session_id) %>%
  keep_where("searchResultPage" %in% event) %>% # remove orphan "visitPage" and "checkin"
  ungroup
cat(" Removed ", n_evnt - nrow(events), " orphan (SERP-less) events.")
rm(n_evnt)

message("Removing sessions falling into multiple test groups")
temp <- events %>%
  group_by(session_id) %>%
  summarize(unique_group = length(unique(group)) == 1)
cat(" Removed ", sum(!temp$unique_group), " sessions falling into multiple test groups.")
events <- events %>%
  keep_where(session_id %in% temp$session_id[temp$unique_group])
rm(temp)

# Number of wikis in the test
n_wiki <- length(unique(events$wiki))
message("Number of wikis in the test: ", n_wiki)
```

```{r search_data, echo=FALSE}
message("Aggregating by search...")
searches <- events %>%
  keep_where(!(is.na(serp_id))) %>% # remove visitPage and checkin events
  arrange(date, session_id, serp_id, timestamp) %>%
  group_by(group, wiki, session_id, serp_id) %>%
  summarize(
    timestamp = timestamp[1],
    `got same-wiki results` = any(`some same-wiki results` == "TRUE", na.rm = TRUE),
    engaged = any(event != "searchResultPage") || length(unique(page_id[event == "searchResultPage"])) > 1,
    `same-wiki clickthrough` = "click" %in% event,
    `other clickthrough` = sum(grepl("click", event) & event != "click"),
    `no. same-wiki results clicked` = length(unique(event_position[event == "click"])),
    `first clicked same-wiki results position` = ifelse(`same-wiki clickthrough`, event_position[event == "click"][1], NA), # event_position is 0-based
    `max clicked position (same-wiki)` = ifelse(`same-wiki clickthrough`, max(event_position[event == "click"], na.rm = TRUE), NA),
    `Query score (F=0.1)` = query_score(event_position, 0.1),
    `Query score (F=0.5)` = query_score(event_position, 0.5),
    `Query score (F=0.9)` = query_score(event_position, 0.9)
  ) %>%
  ungroup
```

```{r visitpage_data, echo=FALSE}
message("Aggregating by visited page (after clickthrough)...")
visitPage_action <- all(c("visitPage", "checkin") %in% events$event)
if (visitPage_action) {
  visitedPages <- events %>%
    arrange(date, session_id, page_id, timestamp) %>%
    group_by(group, wiki, session_id, page_id) %>%
    keep_where("visitPage" %in% event) %>% # keep only checkin and visitPage action
    summarize(
      timestamp = timestamp[1],
      position = na.omit(event_position)[1][1],
      dwell_time = ifelse("checkin" %in% event, max(event_checkin, na.rm = TRUE), 0),
      scroll = sum(event_scroll) > 0,
      status = ifelse(dwell_time == "420", 1, 2)
    ) %>%
    ungroup
  visitedPages$dwell_time[is.na(visitedPages$dwell_time)] <- 0
}
```

```{r serp_extra_param, echo=FALSE}
if ("searchResultPage" %in% events$event & !is.null(events$event_extraParams)) {

  message("Processing SERP offset data...")
  serp_offset <- events %>%
    keep_where(event == "searchResultPage", `some same-wiki results` == "TRUE") %>%
    # SERPs with 0 results will not have an offset in extraParams ^
    mutate(offset = purrr::map_int(event_extraParams, ~ parse_extraParams(.x, action = "searchResultPage")$offset)) %>%
    select(session_id, event_id, serp_id, offset)

  message("Processing SERP interwiki data...")
  extract_iw <- function(session_id, event_id, serp_id, event_extraParams) {
    return(data.frame(
      session_id, event_id, serp_id,
      parse_extraParams(event_extraParams, action = "searchResultPage")$iw,
      stringsAsFactors = FALSE
    ))
  }
  serp_iw <- events %>%
    keep_where(event == "searchResultPage") %>%
    select(session_id, event_id, serp_id, event_extraParams) %>%
    purrr::pmap_df(extract_iw) %>%
    mutate(source = case_when(
      source == "wikt" ~ "Wiktionary",
      source == "b" ~ "Wikibooks",
      source == "n" ~ "Wikinews",
      source == "q" ~ "Wikiquote",
      source == "s" ~ "Wikisource",
      source == "v" ~ "Wikiversity",
      source == "voy" ~ "Wikivoyage",
      TRUE ~ source
    ))
}
```

```{r ssclick_extra_param, echo=FALSE}
message("Processing sister-search clicks...")
if ("ssclick" %in% events$event & !is.null(events$event_extraParams)) {
  ssclick_des <- events %>%
    keep_where(event == "ssclick") %>%
    select(session_id, event_id, event_extraParams) %>%
    mutate(domain = urltools::domain(event_extraParams)) %>%
    mutate(
      language = sub("^([a-z]{2}|commons)\\.(wik[a-z]+)\\.org$", "\\1", domain),
      project = sub("^([a-z]{2}|commons)\\.(wik[a-z]+)\\.org$", "\\2", domain)
    ) %>%
    mutate(
      language = ifelse(language == "commons", NA, language),
      project = ifelse(language == "commons", "commons", project)
    ) %>%
    select(-event_extraParams, -domain)
}
```

```{r es_extra_param, echo=FALSE}
# TODO: purrrify
message("Processing explore-similar clicks...")
if ("esclick" %in% events$event & !is.null(events$event_extraParams)) {
  esclick_result <- events %>%
    keep_where(event == "esclick") %>%
    cbind(., do.call(dplyr::bind_rows, lapply(.$event_extraParams, parse_extraParams, action = "esclick"))) %>%
    select(session_id, event_id, hoverId, section, result)
}

message("Processing explore-similar hover events...")
if (all(c("hover-on", "hover-off") %in% events$event) & !is.null(events$event_extraParams)) {
  hover_over <- events %>%
    keep_where(event %in% c("hover-on", "hover-off")) %>%
    cbind(., do.call(dplyr::bind_rows, lapply(.$event_extraParams, parse_extraParams, action = c("hover-on", "hover-off")))) %>%
    select(session_id, event_id, event, hoverId, section, results)
}
```

## Data Summary {.tabset}

Select one of these three tabs:

### Test Summary {.tabset}

```{r summary_table, echo=FALSE, results='asis'}
dplyr::data_frame(
  Days = length(unique(events$date)),
  Events = nrow(events),
  Sessions = length(unique(events$session_id)),
  `Page IDs` = length(unique(events$page_id)),
  SERPs = sum(events$event == "searchResultPage"),
  `Unique search queries` = length(unique(paste(events$session_id, events$query_hash))),
  # ^ includes other events besides SERP
  Searches = length(unique(events$serp_id[!is.na(events$serp_id)])),
  `Same-wiki clicks` = sum(events$event == "click"),
  `Other clicks` = sum(grepl("click", events$event) & events$event != "click")
) %>%
  sapply(., prettyNum, big.mark = ",") %>%
  t() %>%
  knitr::kable()
```

Select one of these sub-tabs:

#### Events

*Action* identifies the context in which the event was created. Every time a new search is performed a **searchEngineResultPage** event is created. When the user clicks a link in the results a **visitPage** event is created. When the user has [dwelled](https://en.wikipedia.org/wiki/Dwell_time_(information_retrieval)) for N seconds a **checkin** event occurs. If the user clicks an interwiki result provided by [TextCat](https://www.mediawiki.org/wiki/TextCat) language detection, there is a **iwclick** event. If the user clicks on a [sister search](https://www.mediawiki.org/wiki/Cross-wiki_Search_Result_Improvements) result from the sidebar, that's an **ssclick.** If the user interacts with a result to explore similar (pages, categories, translations), there are **hover-on**, **hover-off**, and **esclick** events.

```{r event_count_all, echo=FALSE}
events %>%
  group_by(group, event) %>%
  tally %>%
  ggplot(aes(x = event, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  scale_y_continuous(labels = polloi::compress) +
  geom_text(aes(label = n, vjust = -0.5), position = position_dodge(width = 1)) +
  labs(
    y = "Number of events", x = "Action",
    title = "Number of events by test group"
  ) +
  theme_min()
```

```{r event_count_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(5 * n_wiki)}
events %>%
  group_by(group, wiki, event) %>%
  tally %>%
  ggplot(aes(x = event, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  labs(
    y = "Number of Events", x = "Action Type",
    title = "Number of events by test group and wiki"
  ) +
  theme_min()
```

#### Searches

```{r searches_summary, echo=FALSE}
searches %>%
  group_by(`Test group` = group, wiki) %>%
  summarize(
    `Search sessions` = length(unique(session_id)),
    `Searches recorded` = n()
  ) %>%
  ungroup %>% {
    rbind(., tibble::tibble(
      `wiki` = "All wikis",
      `Test group` = "Total",
      `Search sessions` = sum(.$`Search sessions`),
      `Searches recorded` = sum(.$`Searches recorded`)
    ))
  } %>%
  mutate(
    `Search sessions` = prettyNum(`Search sessions`, big.mark = ","),
    `Searches recorded` = prettyNum(`Searches recorded`, big.mark = ",")
  ) %>%
  knitr::kable()
```

#### Searches with _n_ same-wiki results returned

```{r n_results_summary_all, echo=FALSE}
events %>%
  keep_where(event == "searchResultPage") %>%
  mutate(results = if_else(n_results >= 5, "5+ results", Pluralize(n_results, "result"))) %>%
  group_by(group, results) %>%
  summarize(searches = length(unique(serp_id[!is.na(serp_id)]))) %>%
  ggplot(aes(x = results, y = searches, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  scale_y_continuous(labels = polloi::compress) +
  geom_text(aes(label = searches, vjust = -0.5), position = position_dodge(width = 1)) +
  labs(
    y = "Number of searches", x = "Number of same-wiki results returned",
    title = expression(paste("Number of searches with ", italic("n"), " same-wiki result returned, by test group"))
  ) +
  theme_min()
```

```{r n_results_summary_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(5 * n_wiki)}
events %>%
  keep_where(event == "searchResultPage") %>%
  mutate(results = if_else(n_results >= 5, "5+ results", Pluralize(n_results, "result"))) %>%
  group_by(group, wiki, results) %>%
  summarize(searches = length(unique(serp_id[!is.na(serp_id)]))) %>%
  ggplot(aes(x = results, y = searches, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  scale_y_continuous(labels = polloi::compress) +
  geom_text(aes(label = searches, vjust = -0.5), position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  labs(
    y = "Number of searches", x = "Number of same-wiki results returned",
    title = expression(paste("Number of searches with ", italic("n"), " same-wiki result returned, by test group"))
  ) +
  theme_min()
```

`r if (exists("serp_offset")) { "#### SERPs by offset" }`

```{r serp_offset_summary_all, eval=exists("serp_offset"), echo=FALSE}
serp_offset %>%
  keep_where(!is.na(offset)) %>%
  mutate(offset = case_when(
    offset == 0 ~ "No offset (page 1)",
    offset >= 100 ~ "100+ results",
    TRUE ~ Pluralize(offset, "result")
  )) %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  group_by(group, offset) %>%
  tally %>%
  ggplot(aes(x = offset, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(limits = c("No offset (page 1)", Pluralize(c(20, 40, 60, 80), "result"), "100+ results")) +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of SERPs", x = "Offset",
    title = expression(paste("Number of SERPs with ", italic("n"), " offset results, by test group")),
    caption = "This can be regarded as a proxy for users visiting additional pages of their search results."
  ) +
  theme_min()
```

```{r serp_offset_summary_wiki, eval=(exists("serp_offset") & n_wiki > 1), echo=FALSE, fig.height=5*n_wiki}
serp_offset %>%
  keep_where(!is.na(offset)) %>%
  mutate(offset = case_when(
    offset == 0 ~ "No offset (page 1)",
    offset >= 100 ~ "100+ results",
    TRUE ~ Pluralize(offset, "result")
  )) %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  group_by(group, wiki, offset) %>%
  tally %>%
  ggplot(aes(x = offset, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(limits = c("No offset (page 1)", Pluralize(c(20, 40, 60, 80), "result"), "100+ results")) +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  labs(
    y = "Number of SERPs", x = "Offset",
    title = expression(paste("Number of SERPs with ", italic("n"), " offset results, by test group")),
    caption = "This can be regarded as a proxy for users visiting additional pages of their search results."
  ) +
  theme_min()
```

`r if ("user_agent" %in% names(events)) { "#### Browser & OS" }`

The goal here is to see whether the proportions of operating system (OS) and browser usage are similar between the groups. If one group has very different OS/browser share breakdown, there might be something wrong with the implementation that caused or is causing the sampling to bias in favor of some OSes/browsers. **Note** that for brevity, we show only the top 10 OSes/browsers, and that we don't *actually* expect the numbers to be different so this is included purely as a diagnostic.

```{r user_agents, echo=FALSE, eval=("user_agent" %in% names(events))}
user_agents <- dplyr::distinct(events, wiki, session_id, group, user_agent)
null2na <- function(x) {
  return(lapply(x, function(y) {
    if (is.null(y)) {
      return(as.character(NA))
    } else {
      return(y)
    }
  }))
}
user_agents <- user_agents %>%
  cbind(., purrr::map_df(.$user_agent, ~ null2na(jsonlite::fromJSON(.x, simplifyVector = FALSE)))) %>%
  mutate(
    browser = paste(browser_family, browser_major),
    os = case_when(
      is.na(os_major) ~ os_family,
      !is.na(os_major) & !is.na(os_minor) ~ paste0(os_family, " ", os_major, ".", os_minor),
      TRUE ~ paste(os_family, os_major)
    )
  )
summarize_uas <- function(data) {
  data %>%
    tally %>%
    mutate(prop = paste0(scales::percent_format()(n/sum(n)), " (", n, ")")) %>%
    select(-n) %>%
    tidyr::spread(group, prop) %>%
    knitr::kable()
}
```
```{r os_table, echo=FALSE, results='asis', eval=("user_agent" %in% names(events))}
top_10_oses <- names(head(sort(table(user_agents$os), decreasing = TRUE), 10))
user_agents %>%
  mutate(os = if_else(os %in% top_10_oses, os, "Other OSes")) %>%
  group_by(wiki, group, os) %>%
  summarize_uas
```
```{r browser_table, echo=FALSE, results='asis', eval=("user_agent" %in% names(events))}
top_10_browsers <- names(head(sort(table(user_agents$browser), decreasing = TRUE), 10))
user_agents %>%
  mutate(browser = if_else(browser %in% top_10_browsers, browser, "Other browsers")) %>%
  group_by(wiki, group, browser) %>%
  summarize_uas
```
```{r ua_cleanup, echo=FALSE}
rm(user_agents, top_10_oses, top_10_browsers)
```

### Sister Search {.tabset}

Select one of these sub-tabs:

`r if (exists("serp_iw")) { "#### Sidebar results by source and position" }`

```{r serp_iw_summary, eval=exists("serp_iw"), echo=FALSE}
serp_iw %>%
  keep_where(!is.na(source), !is.na(position)) %>%
  mutate(position = paste(safe_ordinals(position), "result")) %>%
  group_by(source, position) %>%
  summarize(counts = length(unique(event_id))) %>%
  xtabs(counts ~ source + position, data = .) %>%
  addmargins %>%
  knitr::kable()
```

```{r serp_iw_breakdown_all, eval=exists("serp_iw"), echo=FALSE}
serp_iw %>%
  keep_where(!is.na(source), !is.na(position)) %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  mutate(position = paste(safe_ordinals(position), "result")) %>%
  group_by(group, source, position) %>%
  summarize(counts = length(unique(event_id))) %>%
  ggplot(aes(x = source, y = counts, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = counts, vjust = -0.5), size = 2, position = position_dodge(width = 1)) +
  labs(
    y = "Number of SERPs", x = "Source",
    title = "Number of SERPs' sister-search sidebar results by source, position and test group"
  ) +
  facet_wrap(~ position, scale = "free_y") +
  theme_facet(axis.text.x = element_text(angle = 90))
```

```{r serp_iw_breakdown_wiki, eval=(exists("serp_iw") & n_wiki > 1), echo=FALSE, fig.width=11, fig.height=(6 * n_wiki)}
serp_iw %>%
  keep_where(!is.na(source), !is.na(position)) %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  mutate(position = paste(safe_ordinals(position), "result")) %>%
  group_by(group, wiki, source, position) %>%
  summarize(counts = length(unique(event_id))) %>%
  ggplot(aes(x = source, y = counts, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = counts, vjust = -0.5), size = 2, position = position_dodge(width = 1)) +
  labs(
    y = "Number of SERPs", x = "Source",
    title = "Number of SERPs' sister-search sidebar results by source, position, test group and wiki"
  ) +
  facet_grid(wiki ~ position, scale = "free_y") +
  theme_facet(axis.text.x = element_text(angle = 90))
```

`r if (exists("ssclick_des")) { "#### Clicks by project" }`

```{r ssclick_project_all, eval=exists("ssclick_des"), echo=FALSE}
ssclick_des %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  group_by(group, project) %>%
  tally %>%
  ggplot(aes(x = project, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), position = position_dodge(width = 1)) +
  labs(
    y = "Number of Sister Search Clicks", x = "Project",
    title = "Number of sister search clicks by project and test group"
  ) +
  theme_min()
```

```{r ssclick_project_wiki, eval=(exists("ssclick_des") & n_wiki > 1), echo=FALSE, fig.height=(5*n_wiki)}
ssclick_des %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  group_by(group, wiki, project) %>%
  tally %>%
  ggplot(aes(x = project, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of Sister Search Clicks", x = "Project",
    title = "Number of sister search clicks by project, test group and wiki"
  ) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  theme_min()
```

`r if ("ssclick" %in% events$event) { "#### Clicks by position" }`

```{r ssclick_position_all, eval="ssclick" %in% events$event, echo=FALSE}
events %>%
  keep_where(event == "ssclick") %>%
  group_by(group, event_position) %>%
  tally %>%
  mutate(position = paste(safe_ordinals(event_position), "result")) %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of Sister Search Clicks", x = "Clicked Position",
    title = "Number of sister search clicks by clicked position and test group"
  ) +
  theme_min()
```

```{r ssclick_position_wiki, eval=("ssclick" %in% events$event & n_wiki > 1), echo=FALSE, fig.height=(5 * n_wiki)}
events %>%
  keep_where(event == "ssclick") %>%
  group_by(group, wiki, event_position) %>%
  tally %>%
  mutate(position = paste(safe_ordinals(event_position), "result")) %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of Sister Search Clicks", x = "Clicked Position",
    title = "Number of sister search clicks by clicked position, test group and wiki"
  ) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  theme_min()
```

`r if ("iwclick" %in% events$event) { "#### Inter-wiki clicks by position" }`

```{r iwclick_position_all, eval=("iwclick" %in% events$event), echo=FALSE}
events %>%
  keep_where(event == "iwclick") %>%
  mutate(position = ifelse(event_position < 4, safe_ordinals(event_position + 1), "5th or higher")) %>%
  group_by(group, position) %>%
  tally %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of inter-wiki clicks", x = "Clicked Position",
    title = "Number of inter-wiki clicks by clicked position and test group",
    subtitle = "Inter-wiki results are provided by TextCat language detection"
  ) +
  theme_facet()
```

```{r iwclick_position_wiki, eval=("iwclick" %in% events$event & n_wiki > 1), echo=FALSE, fig.height=(5 * n_wiki)}
events %>%
  keep_where(event == "iwclick") %>%
  mutate(position = ifelse(event_position < 4, safe_ordinals(event_position + 1), "5th or higher")) %>%
  group_by(group, wiki, position) %>%
  tally %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of inter-wiki clicks", x = "Clicked Position",
    title = "Number of inter-wiki clicks by clicked position, test group, and wiki",
    subtitle = "Inter-wiki results are provided by TextCat language detection"
  ) +
  facet_wrap(~ wiki, nrow = n_wiki, scales = "free_y") +
  theme_facet()
```

### Explore Similar {.tabset}

Select one of these sub-tabs:

`r if (exists("esclick_result")) { "#### Clicks by section and position" }`

```{r esclick_summary, eval=exists("esclick_result"), echo=FALSE}
esclick_result %>%
  mutate(
    section = ifelse(is.na(section), "NA", section),
    result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))
  ) %>%
  group_by(section, result) %>%
  tally %>%
  xtabs(n ~ section + result, data = .) %>%
  addmargins %>%
  knitr::kable()
```

```{r esclick_breakdown_all, eval=exists("esclick_result"), echo=FALSE}
esclick_result %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  mutate(
    section = ifelse(is.na(section), "NA", section),
    result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))
  ) %>%
  group_by(group, section, result) %>%
  tally %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5,
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of Explore Similar Clicks", x = "Section",
    title = "Number of explore similar clicks by section, clicked position and test group"
  ) +
  facet_wrap(~ result, scale = "free_y") +
  theme_min(axis.text.x = element_text(angle = 90))
```

```{r esclick_breakdown_wiki, eval=(exists("esclick_result") & n_wiki > 1), echo=FALSE, fig.height=6*n_wiki}
esclick_result %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  mutate(
    section = ifelse(is.na(section), "NA", section),
    result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))
  ) %>%
  group_by(group, wiki, section, result) %>%
  tally %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5,
            position = position_dodge(width = 1)) +
  labs(
    y = "Number of Explore Similar Clicks", x = "Section",
    title = "Number of explore similar clicks by section, clicked position, test group and wiki") +
  facet_grid(wiki ~ result, scale = "free_y") +
  theme_facet(border = FALSE, axis.text.x = element_text(angle = 90))
```

`r if (exists("hover_over")) { "#### Hover-overs by section and results" }`

```{r hover_summary, eval=exists("hover_over"), echo=FALSE}
hover_over %>%
  keep_where(event == "hover-on") %>%
  mutate(results = ifelse(results >= 5, "5+ results", Pluralize(results, "result"))) %>%
  group_by(section, results) %>%
  tally %>%
  xtabs(n ~ section + results, data = .) %>%
  addmargins %>%
  knitr::kable()
```

```{r hover_breakdown_all, eval=exists("hover_over"), echo=FALSE}
hover_over %>%
  keep_where(event == "hover-on") %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  mutate(
    section = ifelse(is.na(section), "NA", section),
    results = ifelse(is.na(results), "NA", ifelse(results >= 5, "5+ results", Pluralize(results, "result")))
  ) %>%
  group_by(group, section, results) %>%
  tally %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5, position = position_dodge(width = 1)) +
  labs(
    y = "Number of Hover-Over", x = "Section",
    title = "Number of hover-over events by section, number of results and test group"
  ) +
  facet_wrap(~ results, scale = "free_y") +
  theme_facet(axis.text.x = element_text(angle = 90))
```

```{r hover_breakdown_wiki, eval=(exists("hover_over") & n_wiki > 1), echo=FALSE, fig.width=11, fig.height=(6 * n_wiki)}
hover_over %>%
  keep_where(event == "hover-on") %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  mutate(
    section = ifelse(is.na(section), "NA", section),
    results = ifelse(is.na(results), "NA", ifelse(results >= 5, "5+ result(s)", Pluralize(results, "result")))
  ) %>%
  group_by(group, wiki, section, results) %>%
  tally %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5, position = position_dodge(width = 1)) +
  labs(y = "Number of Hover-Over", x = "Section",
       title = "Number of hover-over events by section, number of results, test group and wiki") +
  facet_grid(wiki ~ results, scale = "free_y") +
  theme_facet(axis.text.x = element_text(angle = 90))
```

## Results of Statistical Analysis

### Same-wiki Zero Results Rate

```{r zrr_all, echo=FALSE}
searches %>%
  group_by(group) %>%
  summarize(zero = sum(!`got same-wiki results`), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$zero, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Zero Results Rate",
    title = "Proportion of searches that did not yield any same-wiki results, by test group",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  theme_facet(border = FALSE)
```

```{r zrr_wiki, echo=FALSE, eval=n_wiki > 1, fig.height=6*ceiling(n_wiki/3)}
searches %>%
  group_by(group, wiki) %>%
  summarize(zero = sum(!`got same-wiki results`), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$zero, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Zero Results Rate",
    title = "Proportion of searches that did not yield any same-wiki results, by test group and wiki",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, ncol = 3, scales = "free_y") +
  theme_facet()
```

### Same-wiki Engagement

```{r engagement_all, echo=FALSE}
samewiki_ctr_all <- searches %>% # save object samewiki_ctr_all for odds ratio plot
  keep_where(`got same-wiki results` == TRUE) %>%
  group_by(group) %>%
  summarize(clickthroughs = sum(`same-wiki clickthrough`), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$clickthroughs, n = .$n_search, conf.level = 0.95))
  )
samewiki_ctr_all %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Clickthrough rate",
    title = "Same-wiki clickthrough rates by test group",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  theme_facet(border = FALSE)
```

```{r engagement_OR_all, echo=FALSE, results='asis', include=TRUE}
control_group <- grep("control", params$`test_group_names`, value = TRUE)
test_group <- setdiff(params$`test_group_names`, control_group)

for (this_group in test_group) {
  cat("**", this_group, " vs. ", control_group, "** \n", sep = "")
  this_plot <- samewiki_ctr_all %>%
    keep_where(group %in% c(control_group, this_group)) %>%
    arrange(desc(group)) %>%
    dplyr::do(BCDA::tidy(BCDA::beta_binom(.$x, .$n), interval_type = "HPD")) %>%
    ungroup %>%
    mutate(term = factor(
      term,
      levels = c("p2", "p1", "prop_diff", "relative_risk", "odds_ratio"),
      labels = c("Pr[Control Engaging]", "Pr[Test Engaging]", "Pr[Test] - Pr[Control]", "Relative Risk", "Odds Ratio")
    )) %>%
    ggplot(aes(x = 1, y = estimate, ymin = conf.low, ymax = conf.high)) +
    geom_segment(y = 1, yend = 1, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
    geom_segment(y = 0, yend = 0, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
    geom_pointrange() +
    geom_text(aes(label = round(estimate, 4), y = estimate,
                  hjust = "left"), nudge_x = 0.005) +
    facet_grid(term ~ ., scales = "free_y") +
    scale_x_continuous(limits = c(0.99, 1.05)) +
    labs(
      x = NULL, y = "Estimate",
      title = "How likely test group users were to engage with search results",
      subtitle = "95% credible intervals calculated as Highest Posterior Density (HPD) intervals"
    ) +
    theme_facet(strip.text.y = element_text(size = 12, angle = 0))
  print(this_plot)
  cat("\n")
}
```

```{r engagement_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(6 * ceiling(n_wiki / 3))}
samewiki_ctr_bywiki <- searches %>% # save object samewiki_ctr_bywiki for odds ratio plot
  keep_where(`got same-wiki results`) %>%
  group_by(group, wiki) %>%
  summarize(clickthroughs = sum(`same-wiki clickthrough`), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$clickthroughs, n = .$n_search, conf.level = 0.95))
  )
samewiki_ctr_bywiki %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, ncol = 3, scales = "free_y") +
  labs(
    x = NULL, y = "Clickthrough rate",
    title = "Same-wiki clickthrough rates by test group and wiki",
    subtitle = "With 95% credible intervals."
  ) +
  theme_facet()
```

```{r engagement_OR_wiki, eval=(n_wiki > 1), echo=FALSE, results='asis', include=TRUE}
control_group <- grep("control", params$`test_group_names`, value = TRUE)
test_group <- setdiff(params$`test_group_names`, control_group)

for (this_group in test_group) {
  cat("**", this_group, " vs. ", control_group, " by wiki** \n", sep = "")
  this_plot <- samewiki_ctr_bywiki %>%
    keep_where(group %in% c(control_group, this_group)) %>%
    arrange(wiki, desc(group)) %>%
    group_by(wiki) %>%
    dplyr::do(BCDA::tidy(BCDA::beta_binom(.$x, .$n), interval_type = "HPD")) %>%
    ungroup %>%
    mutate(term = factor(
      term,
      levels = c("p2", "p1", "prop_diff", "relative_risk", "odds_ratio"),
      labels = c("Pr[Control Engaging]", "Pr[Test Engaging]", "Pr[Test] - Pr[Control]", "Relative Risk", "Odds Ratio")
    )) %>%
    ggplot(aes(x = 1, y = estimate, ymin = conf.low, ymax = conf.high)) +
    geom_segment(y = 1, yend = 1, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
    geom_segment(y = 0, yend = 0, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
    geom_pointrange() +
    geom_text(aes(label = round(estimate, 4), y = estimate,
                  hjust = "left"), nudge_x = 0.005) +
    facet_grid(term ~ wiki, scales = "free_y") +
    scale_x_continuous(limits = c(0.99, 1.05)) +
    labs(
      x = NULL, y = "Estimate",
      title = "How likely test group users were to engage with search results",
      subtitle = "95% credible intervals calculated as Highest Posterior Density (HPD) intervals"
    ) +
    theme_facet(strip.text.y = element_text(size = 12, angle = 0))
  print(this_plot)
  cat("\n")
}
```

### First Clicked Same-Wiki Result's Position

```{r first_clicked_all, echo=FALSE}
searches %>%
  keep_where(
    `got same-wiki results`,
    `same-wiki clickthrough`,
    !is.na(`first clicked same-wiki results position`)
  ) %>%
  mutate(`first clicked result's position` = ifelse(`first clicked same-wiki results position` < 4, safe_ordinals(`first clicked same-wiki results position` + 1), "5th or higher")) %>%
  group_by(group, `first clicked result's position`) %>%
  tally %>%
  mutate(total = sum(n)) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$n, n = .$total, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  facet_wrap(~ `first clicked result's position`, ncol = 5, scales = "free_y") +
  labs(x = NULL, y = "Proportion of searches",
       title = "Position of the first clicked same-wiki result by test group",
       subtitle = "With 95% credible intervals") +
  theme_facet()
```

```{r first_clicked_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(4 * n_wiki)}
searches %>%
  keep_where(
    `got same-wiki results`,
    `same-wiki clickthrough`,
    !is.na(`first clicked same-wiki results position`)
  ) %>%
  mutate(`first clicked result's position` = ifelse(`first clicked same-wiki results position` < 4, safe_ordinals(`first clicked same-wiki results position` + 1), "5th or higher")) %>%
  group_by(group, wiki, `first clicked result's position`) %>%
  tally %>%
  mutate(total = sum(n)) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$n, n = .$total, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  facet_wrap(~ wiki + `first clicked result's position`, ncol = 5, scale = "free_y") +
  labs(
    x = NULL, y = "Proportion of searches",
    title = "Position of the first clicked same-wiki result by test group and wiki",
    subtitle = "With 95% credible intervals"
  ) +
  theme_facet()
```

### Maximum Clicked Position for Same-Wiki Results

```{r max_clicked_all, echo=FALSE}
searches %>%
  keep_where(
    `got same-wiki results`,
    `same-wiki clickthrough`,
    !is.na(`max clicked position (same-wiki)`)
  ) %>%
  mutate(
    `max clicked position (same-wiki)` = case_when(
      `max clicked position (same-wiki)` < 4 ~ safe_ordinals(`max clicked position (same-wiki)` + 1),
      `max clicked position (same-wiki)` >= 4 & `max clicked position (same-wiki)` < 20 ~ "5th - 20th",
      TRUE ~ "21st or higher"
      )
  ) %>%
  group_by(group, `max clicked position (same-wiki)`) %>%
  summarize(counts = n()) %>%
  mutate(total = sum(counts)) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$counts, n = .$total, conf.level = 0.95))
  ) %>%
  mutate(`max clicked position (same-wiki)` = factor(`max clicked position (same-wiki)`, levels = c("1st", "2nd", "3rd", "4th", "5th - 20th", "21st or higher"))) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  facet_wrap(~ `max clicked position (same-wiki)`, ncol = 6, scale = "free_y") +
  labs(
    x = NULL, y = "Proportion of searches",
    title = "Maximum clicked position for same-wiki results, by test group",
    subtitle = "With 95% credible intervals"
  ) +
  theme_facet()
```

```{r max_clicked_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(4 * n_wiki)}
searches %>%
  keep_where(
    `got same-wiki results`,
    `same-wiki clickthrough`,
    !is.na(`max clicked position (same-wiki)`)
  ) %>%
  mutate(
    `max clicked position (same-wiki)` = case_when(
      `max clicked position (same-wiki)` < 4 ~ safe_ordinals(`max clicked position (same-wiki)` + 1),
      `max clicked position (same-wiki)` >= 4 & `max clicked position (same-wiki)` < 20 ~ "5th - 20th",
      TRUE ~ "21st or higher"
      )
  ) %>%
  group_by(group, wiki, `max clicked position (same-wiki)`) %>%
  summarize(counts = n()) %>%
  mutate(total = sum(counts)) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$counts, n = .$total, conf.level = 0.95))
  ) %>%
  mutate(`max clicked position (same-wiki)` = factor(`max clicked position (same-wiki)`, levels = c("1st", "2nd", "3rd", "4th", "5th - 20th", "21st or higher"))) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  facet_wrap(~ wiki + `max clicked position (same-wiki)`, ncol = 6, scale = "free_y") +
  labs(
    x = NULL, y = "Proportion of searches",
    title = "Maximum clicked position for same-wiki results, by test group and wiki",
    subtitle = "With 95% credible intervals"
  ) +
  theme_facet()
```

### PaulScore

[PaulScore](https://www.mediawiki.org/wiki/Wikimedia_Discovery/Search/Glossary#PaulScore) is a measure of search results' relevancy which takes into account the position of the clicked results, and is computed via the following steps:

#. Pick scoring factor $0 < F < 1$ (larger values of $F$ increase the weight of clicks on lower-ranked results).
#. For $i$-th search session $S_i$ $(i = 1, \ldots, n)$ containing $m$ queries $Q_1, \ldots, Q_m$ and search result sets $\mathbf{R}_1, \ldots, \mathbf{R}_m$:
(#) For each $j$-th search query $Q_j$ with result set $\mathbf{R}_j$, let $\nu_j$ be the query score: $$\nu_j = \sum_{k~\in~\{\text{0-based positions of clicked results in}~\mathbf{R}_j\}} F^k.$$
(#) Let user's average query score $\bar{\nu}_{(i)}$ be $$\bar{\nu}_{(i)} = \frac{1}{m} \sum_{j = 1}^m \nu_j.$$
#. Then the PaulScore is the average of all users' average query scores: $$\text{PaulScore}(F)~=~\frac{1}{n} \sum_{i = 1}^n \bar{\nu}_{(i)}.$$

We can calculate the confidence interval of PaulScore$(F)$ by approximating its distribution via [boostrapping](https://en.wikipedia.org/wiki/Bootstrapping_(statistics)).

```{r paulscores_all, echo=FALSE}
searches %>%
  ungroup %>%
  keep_where(`same-wiki clickthrough` == TRUE) %>%
  select(c(group, `Query score (F=0.1)`, `Query score (F=0.5)`, `Query score (F=0.9)`)) %>%
  tidyr::gather(`F value`, `Query score`, -group) %>%
  mutate(`F value` = sub("^Query score \\(F=(0\\.[159])\\)$", "F = \\1", `F value`)) %>%
  group_by(group, `F value`) %>%
  summarize(
    PaulScore = mean(`Query score`),
    Interval = paste0(quantile(bootstrap_mean(`Query score`, 1000), c(0.025, 0.975)), collapse = ",")
  ) %>%
  tidyr::extract(Interval, into = c("Lower", "Upper"), regex = "(.*),(.*)", convert = TRUE) %>%
  ggplot(aes(x = `F value`, y = PaulScore, color = group)) +
  geom_pointrange(aes(ymin = Lower, ymax = Upper), position = position_dodge(width = 0.7)) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "PaulScore",
    title = "PaulScore by test group and value of F",
    subtitle = "With bootstrapped 95% confidence intervals."
  ) +
  geom_text(aes(label = sprintf("%.3f", PaulScore), y = Upper + 0.01, vjust = "bottom"),
            position = position_dodge(width = 0.7)) +
  theme_min()
```

```{r paulscores_wiki, echo=FALSE, eval=(n_wiki > 1), fig.height=(6 * ceiling(n_wiki / 3))}
searches %>%
  ungroup %>%
  keep_where(`same-wiki clickthrough` == TRUE) %>%
  select(c(wiki, group, `Query score (F=0.1)`, `Query score (F=0.5)`, `Query score (F=0.9)`)) %>%
  tidyr::gather(`F value`, `Query score`, -c(group, wiki)) %>%
  mutate(`F value` = sub("^Query score \\(F=(0\\.[159])\\)$", "F = \\1", `F value`)) %>%
  group_by(wiki, group, `F value`) %>%
  summarize(
    PaulScore = mean(`Query score`),
    Interval = paste0(quantile(bootstrap_mean(`Query score`, 1000), c(0.025, 0.975)), collapse = ",")
  ) %>%
  tidyr::extract(Interval, into = c("Lower", "Upper"), regex = "(.*),(.*)", convert = TRUE) %>%
  ggplot(aes(x = `F value`, y = PaulScore, color = group)) +
  geom_pointrange(aes(ymin = Lower, ymax = Upper), position = position_dodge(width = 0.7)) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "PaulScore",
    title = "PaulScore by wiki, test group and value of F",
    subtitle = "With bootstrapped 95% confidence intervals."
  ) +
  geom_text(aes(label = sprintf("%.3f", PaulScore), y = Upper + 0.01, vjust = "bottom"),
            position = position_dodge(width = 0.7)) +
  facet_wrap(~ wiki, ncol = 3, scales = "free_y") +
  theme_min()
```

`r if (exists("serp_offset")) { "### Other Pages of the Search Results" }`

```{r search_offset_all, eval=exists("serp_offset"), echo=FALSE}
serp_offset %>%
  group_by(session_id, serp_id) %>%
  summarize(`Any page-turning` = any(offset > 0)) %>%
  dplyr::right_join(searches, by = c("session_id", "serp_id")) %>%
  group_by(group) %>%
  summarize(page_turn = sum(`Any page-turning`, na.rm = TRUE), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$page_turn, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Proportion of searches",
    title = "Proportion of searches with clicks to see other pages of the search results, by test group",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  theme_facet(border = FALSE)
```

```{r search_offset_wiki, eval=(exists("serp_offset") & n_wiki > 1), echo=FALSE, fig.height=(6 * ceiling(n_wiki / 3))}
serp_offset %>%
  group_by(session_id, serp_id) %>%
  summarize(`Any page-turning` = any(offset > 0)) %>%
  dplyr::right_join(searches, by = c("session_id", "serp_id")) %>%
  group_by(group, wiki) %>%
  summarize(page_turn = sum(`Any page-turning`, na.rm = TRUE), n_search = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$page_turn, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Proportion of searches",
    title = "Proportion of searches with clicks to see other pages of the search results, by test group and wiki",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, ncol = 3, scales = "free_y") +
  theme_facet(border = FALSE)
```

`r if (exists("visitedPages")) { "### Dwell Time Per Visited Page" }`

```{r survival_all, eval=exists("visitedPages"), echo=FALSE}
temp <- visitedPages
temp$SurvObj <- with(temp, survival::Surv(dwell_time, status == 2))
fit <- survival::survfit(SurvObj ~ group, data = temp)
ggsurv <- survminer::ggsurvplot(
  fit,
  conf.int = TRUE,
  xlab = "T (Dwell Time in seconds)",
  ylab = "Proportion of visits longer than T (P%)",
  surv.scale = "percent",
  palette = "Set1",
  legend = "bottom",
  legend.title = "Group",
  legend.labs = params$test_group_names,
  ggtheme = theme_min()
)
ggsurv$plot +
  labs(
    title = "Survival curves by test group",
    subtitle = "With 95% confidence intervals."
  )
rm(temp)
```

```{r survival_wiki, eval=(exists("visitedPages") & n_wiki > 1), echo=FALSE, fig.height=(4 * n_wiki)}
temp <- visitedPages
temp$SurvObj <- with(temp, survival::Surv(dwell_time, status == 2))
fit <- survival::survfit(SurvObj ~ group + wiki, data = temp)
ggsurv <- survminer::ggsurvplot(
  fit,
  conf.int = TRUE,
  xlab = "T (Dwell Time in seconds)",
  ylab = "Proportion of visits longer than T (P%)",
  surv.scale = "percent",
  palette = "Set1",
  legend.title = "Group",
  ggtheme = theme_facet()
)
ggsurv$plot +
  facet_wrap(~ wiki, ncol = 1, scales = "free_y") +
  labs(
    title = "Survival curves by test group and wiki",
    subtitle = "With 95% confidence intervals."
  )
rm(temp)
```

`r if (exists("visitedPages")) { "### Scroll" }`

```{r scroll_all, eval=exists("visitedPages"), echo=FALSE}
visitedPages %>%
  group_by(group) %>%
  summarize(scrolls = sum(scroll), n_visit = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$scrolls, n = .$n_visit, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(x = NULL, y = "Proportion of visits",
       title = "Proportion of visits with scroll by test group",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  theme_facet(border = FALSE)
```

```{r scroll_wiki, eval=(exists("visitedPages") & n_wiki > 1), echo=FALSE, fig.height=(6 * ceiling(n_wiki / 3))}
visitedPages %>%
  group_by(group, wiki) %>%
  summarize(scrolls = sum(scroll), n_visit = n()) %>%
  ungroup %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$scrolls, n = .$n_visit, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer("Group", palette = "Set1") +
  labs(
    x = NULL, y = "Proportion of visits",
    title = "Proportion of visits with scroll by test group and wiki",
    subtitle = "With 95% credible intervals."
  ) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, ncol = 3, scales = "free_y") +
  theme_facet(border = FALSE)
```
