---
params: 
  report_title: A/B Test Analysis
  phab_ticket: T149809
  test_description: "Some text"
  data: ./data/AB Test Analysis/events_raw_20170716170323.RData
  query: 'SELECT * FROM TestSearchSatisfaction2_16909631;' 
  start_date: 20170630 # inclusive
  end_date: 20170707 # exclusive
  TSS2 revision number: 16909631
  wiki: enwiki
  test_group_names: [explore_similar_control, explore_similar_test]
  event_action: [searchResultPage, click]
  event_source: fulltext # don't support autocomplete now
  other_filter: "event_searchSessionId <> 'explore_similar_test'"
title: "`r params$report_title`"
date: '`r Sys.Date()`'
output: 
  html_document:
    fig_width: 10
    fig_height: 6
    highlight: zenburn
    keep_md: true
    mathjax: https://tools-static.wmflabs.org/cdnjs/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML
    md_extensions: +raw_html +markdown_in_html_blocks +tex_math_dollars +fancy_lists +startnum +lists_without_preceding_blankline
    self_contained: false
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    code_folding: hide
---
```{js, echo = FALSE}
$(function() {
  /* Lets the user click on the images to view them in full resolution. */
  $("img").wrap(function() {
    var link = $('<a/>');
    link.attr('href', $(this).attr('src'));
    link.attr('target', '_blank');
    return link;
  });
});
```
```{r setup, echo=FALSE, error=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  error = TRUE, message = FALSE, warning = FALSE
)
set.seed(0)
library(tidyverse)
source("functions.R")
```

`r if (!is.null(params$test_description)) params$test_description`

This test was run from `r lubridate::ymd(params$start_date)` to `r lubridate::ymd(params$end_date) - 1` on `r ifelse(is.null(params$wiki), "all wikis", paste(params$wiki, collapse = ", "))`. We have `r length(params$test_group_names)` test groups: `r paste(params$test_group_names, collapse = ", ")`. We include `r paste(params$event_source, collapse = ", ")` search in this analysis. The phabricator ticket for this test is [`r params$phab_ticket`](`r paste0("https://phabricator.wikimedia.org/", params$phab_ticket)`).

```{r sql_setup, echo=FALSE}
is_stat_machine <- grepl("^stat1", Sys.info()["nodename"])
if (!is_stat_machine & is.null(params$data)){
  # create an SSH tunnel. see https://gist.github.com/scy/6781836
  system("ssh -f -o ExitOnForwardFailure=yes stat3 -L 3307:analytics-store.eqiad.wmnet:3306 sleep 10")
  library(RMySQL)
  con <- dbConnect(MySQL(), host = "127.0.0.1", group = "client", dbname = "log", port = 3307)
}
```

```{r fetch_data, echo=FALSE}
query <- paste0("SELECT
  timestamp,
  event_uniqueId AS event_id,
  event_mwSessionId,
  event_pageViewId AS page_id,
  event_searchSessionId AS session_id,
  event_subTest AS `group`,
  wiki,
  MD5(LOWER(TRIM(event_query))) AS query_hash,
  event_action AS event,
  CASE
    WHEN event_position < 0 THEN NULL
    ELSE event_position
    END AS event_position,
  CASE
    WHEN event_action = 'searchResultPage' AND event_hitsReturned > 0 THEN 'TRUE'
    WHEN event_action = 'searchResultPage' AND event_hitsReturned IS NULL THEN 'FALSE'
    ELSE NULL
    END AS `some same-wiki results`,
  CASE
    WHEN event_action = 'searchResultPage' AND event_hitsReturned > -1 THEN event_hitsReturned
    WHEN event_action = 'searchResultPage' AND event_hitsReturned IS NULL THEN 0
    ELSE NULL
    END AS n_results,
  event_scroll,
  event_checkin,
  event_extraParams,
  event_msToDisplayResults AS load_time,
  event_searchToken AS search_token,
  userAgent AS user_agent
FROM TestSearchSatisfaction2_", params$`TSS2 revision number`, "\n",
"WHERE LEFT(timestamp, 8) >= '", params$start_date, "' AND LEFT(timestamp, 8) < '", params$end_date, "' \n",
ifelse(is.null(params$wiki), "", paste0("  AND wiki IN('", paste(params$wiki, collapse = "', '"), "') \n")),
ifelse(is.null(params$`test_group_names`), "", paste0("  AND event_subTest IN('", paste(params$`test_group_names`, collapse = "', '"), "') \n")),
ifelse(is.null(params$event_action), "", paste0("  AND event_action IN('", paste(params$event_action, collapse = "', '"), "') \n")),
ifelse(is.null(params$event_source), "", paste0("  AND event_source IN('", paste(params$event_source, collapse = "', '"), "') \n")),
ifelse(is.null(params$other_filter), "", paste0("  AND ", params$other_filter, " \n")),
"  AND CASE WHEN event_action = 'searchResultPage' THEN event_msToDisplayResults IS NOT NULL
            WHEN event_action IN ('click', 'iwclick', 'ssclick') THEN event_position IS NOT NULL AND event_position > -1
            WHEN event_action = 'visitPage' THEN event_pageViewId IS NOT NULL
            WHEN event_action = 'checkin' THEN event_checkin IS NOT NULL AND event_pageViewId IS NOT NULL
            ELSE TRUE
       END;"
)
if (!is.null(params$query)) {
  query <- params$query
}
if (is.null(params$data)){
  if (is_stat_machine){
     events_raw <- wmf::mysql_read(query, "log")
  } else{
     events_raw <- wmf::mysql_read(query, "log", con = con)
     dbDisconnect(con)
  }
  # Save raw events data
  if (!dir.exists(file.path("data", gsub(.Platform$file.sep, "", params$report_title)))) {
    dir.create(file.path("data", gsub(.Platform$file.sep, "", params$report_title)), recursive = TRUE)
  }
  save(events_raw, file = file.path("data", gsub(.Platform$file.sep, "", params$report_title), paste0("events_raw_", gsub("[^0-9]", "", Sys.time()), ".RData")))
  print_query <- TRUE
} else{
  if (tools::file_ext(params$data) == "RData"){
    load(params$data)
  } else{
    events_raw <- data.table::fread(input = params$data, data.table = FALSE)
  }
  print_query <- FALSE
}
```

`r if(print_query){"Fetch data: "}`
```{sql, eval = FALSE, code = query, echo = print_query}
```

## Data Cleansing
```{r data_cleansing, echo =FALSE, results='asis'}
if (exists("events_raw")) events <- events_raw

# Events may be duplicated
events <- events %>%
  mutate(timestamp = lubridate::ymd_hms(timestamp),
         date = as.Date(timestamp)) %>%
  dplyr::arrange(session_id, event_id, timestamp) %>%
  dplyr::distinct(session_id, event_id, .keep_all = TRUE)
cat(paste0("Deleted ", nrow(events_raw) - nrow(events), " duplicated events. "))

# SERP De-duplication
SERPs <- events %>%
  dplyr::filter(event == "searchResultPage") %>%
  dplyr::select(c(session_id, page_id, query_hash, search_token)) %>%
  dplyr::group_by(session_id, query_hash) %>%
  dplyr::mutate(serp_id = page_id[1], cirrus_id = search_token[1]) %>%
  dplyr::ungroup() %>%
  dplyr::select(c(page_id, serp_id, cirrus_id))
events <- events %>%
  dplyr::left_join(SERPs, by = "page_id"); rm(SERPs)

# Remove events without SERP asscociated
n_evnt <- nrow(events)
events <- events %>%
  dplyr::filter(!(is.na(serp_id) & !(event %in% c("visitPage", "checkin")))) %>% # remove orphan click
  dplyr::group_by(session_id) %>%
  dplyr::filter("searchResultPage" %in% event) %>% # remove orphan "visitPage" and "checkin"
  dplyr::ungroup()
cat(paste0("Removed ", n_evnt - nrow(events), " orphan (SERP-less) events. ")); rm(n_evnt)

# Remove sessions falling into multiple test groups
temp <- events %>% group_by(session_id) %>% summarise(unique_group = length(unique(group)) == 1)
cat(paste0("Remove ", sum(!temp$unique_group), " sessions falling into multiple test groups. "))
events <- events %>% filter(session_id %in% temp$session_id[temp$unique_group]); rm(temp)

# Number of wikis in the test
n_wiki <- length(unique(events$wiki))
```

```{r search_data, echo=FALSE}
# Aggregate by search
searches <- events %>%
  dplyr::filter(!(is.na(serp_id))) %>% # remove visitPage and checkin events
  dplyr::arrange(date, session_id, serp_id, timestamp) %>%
  dplyr::group_by(group, wiki, session_id, serp_id) %>%
  dplyr::summarize(timestamp = timestamp[1],
                   `got same-wiki results` = any(`some same-wiki results` == "TRUE", na.rm = TRUE),
                   engaged = any(event != "searchResultPage") || length(unique(page_id[event == "searchResultPage"])) > 1,
                   `same-wiki clickthrough` = "click" %in% event,
                   `other clickthrough` = sum(grepl("click", event) & event != "click"),
                   `no. same-wiki results clicked` = length(unique(event_position[event == "click"])),
                   `first clicked same-wiki results position` = ifelse(`same-wiki clickthrough`, event_position[event == "click"][1], NA), # event_position is 0-based
                   `max clicked position (same-wiki)` = ifelse(`same-wiki clickthrough`, max(event_position[event == "click"], na.rm = TRUE), NA),
                   `Query score (F=0.1)` = query_score(event_position, 0.1),
                   `Query score (F=0.5)` = query_score(event_position, 0.5),
                   `Query score (F=0.9)` = query_score(event_position, 0.9)) %>%
  dplyr::ungroup()
```

```{r visitpage_data, echo=FALSE}
# Aggregate by visited page (after clickthrough)
visitPage_action <- all(c("visitPage", "checkin") %in% events$event)
if (visitPage_action){
  visitedPages <- events %>%
    dplyr::arrange(date, session_id, page_id, timestamp) %>%
    dplyr::group_by(group, wiki, session_id, page_id) %>%
    dplyr::filter("visitPage" %in% event) %>% # keep only checkin and visitPage action
    dplyr::summarize(timestamp = timestamp[1],
                     position = na.omit(event_position)[1][1],
                     dwell_time = ifelse("checkin" %in% event, max(event_checkin, na.rm = TRUE), 0),
                     scroll = sum(event_scroll) > 0,
                     status = ifelse(dwell_time == "420", 1, 2)) %>%
    dplyr::ungroup()
  visitedPages$dwell_time[is.na(visitedPages$dwell_time)] <- 0
}
```

```{r serp_extra_param, echo=FALSE}
if ("searchResultPage" %in% events$event){
  # serp offset
  serp_offset <- events %>%
    dplyr::filter(event == "searchResultPage") %>%
    dplyr::mutate(offset = unlist(lapply(.$event_extraParams, function(x) parse_extraParams(x, action = "searchResultPage")$offset))) %>%
    dplyr::select(session_id, event_id, serp_id, offset)

  # serp interwiki results
  temp <- events %>%
    dplyr::filter(event == "searchResultPage") %>%
    dplyr::select(session_id, event_id, serp_id, event_extraParams)
  serp_iw <- do.call(dplyr::bind_rows, 
                     lapply(1:nrow(temp), 
                            function(x) data.frame(session_id = temp$session_id[x], event_id = temp$event_id[x], serp_id = temp$serp_id[x],
                                                   parse_extraParams(temp$event_extraParams[x], action = "searchResultPage")$iw))
                     ) %>%
    dplyr::mutate(source = 
      dplyr::case_when(
        source == "wikt" ~ "wiktionary",
        source == "b" ~ "wikibooks",
        source == "n" ~ "wikinews",
        source == "q" ~ "wikiquote",
        source == "s" ~ "wikisource",
        source == "v" ~ "wikiversity",
        source == "voy" ~ "wikivoyage",
        TRUE ~ source
      )
    )
  rm(temp)
}
```

```{r ssclick_extra_param, echo=FALSE}
# ssclick
if ("ssclick" %in% events$event){
  ssclick_des <- events %>%
    dplyr::filter(event == "ssclick") %>%
    dplyr::select(session_id, event_id, event_extraParams) %>%
    dplyr::mutate(domain = urltools::domain(event_extraParams)) %>%
    dplyr::mutate(language = sub("^([a-z]{2}|commons)\\.(wik[a-z]+)\\.org$", "\\1", domain),
           project = sub("^([a-z]{2}|commons)\\.(wik[a-z]+)\\.org$", "\\2", domain)) %>%
    dplyr::mutate(language = ifelse(language == "commons", NA, language),
           project = ifelse(language == "commons", "commons", project)) %>%
    dplyr::select(-event_extraParams, -domain)
}
```

```{r es_extra_param, echo=FALSE}
# esclick
if ("esclick" %in% events$event){
  esclick_result <- events %>%
    dplyr::filter(event == "esclick") %>%
    cbind(., do.call(dplyr::bind_rows, lapply(.$event_extraParams, parse_extraParams, action =  "esclick"))) %>%
    dplyr::select(session_id, event_id, hoverId, section, result)
}

# hover-on and hover-off
if (all(c("hover-on", "hover-off") %in% events$event)){
  hover_over <- events %>%
    dplyr::filter(event %in% c("hover-on", "hover-off")) %>%
    cbind(., do.call(dplyr::bind_rows, lapply(.$event_extraParams, parse_extraParams, action =  c("hover-on", "hover-off")))) %>%
    dplyr::select(session_id, event_id, event, hoverId, section, results)
}
```

## Data Summary {.tabset}

### Test Summary

```{r test_summary, echo=FALSE}
dplyr::data_frame(
  Days = length(unique(events$date)),
  Events = nrow(events),
  Sessions = length(unique(events$session_id)),
  `Page IDs` = length(unique(events$page_id)),
  SERPs = sum(events$event == "searchResultPage"),
  `Unique search queries` = length(unique(paste(events$session_id, events$query_hash))), # includes other events besides SERP
  Searches = length(unique(events$serp_id[!is.na(events$serp_id)])),
  `Same-wiki clicks` = sum(events$event == "click"),
  `Other clicks` = sum(grepl("click", events$event) & events$event != "click")
) %>% 
  sapply(., prettyNum, big.mark = ",") %>%
  t() %>%
  knitr::kable()
```

#### Number of events

Action identifies the context in which the event was created. Every time a new search is performed a searchEngineResultPage event is created. When the user clicks a link in the results a visitPage event is created. When the user has dwelled for N seconds a checkin event occurs. If the user clicks an interwiki result provided by TextCat language detection, there is a iwclick event. If the user clicks on a sister search result from the sidebar, that's an ssclick. If the user interacts with a result to explore similar (pages, categories, translations), there are hover-on, hover-off, and esclick events.

```{r event_count, echo=FALSE, fig.height=6*n_wiki}
events %>%
  dplyr::group_by(group, event) %>%
  dplyr::tally() %>%
  ggplot(aes(x = event, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of Events", x = "Action Type",
       title = "Number of events by test group") +
  theme(legend.position = "bottom")

if (n_wiki > 1){
  events %>%
    dplyr::group_by(group, wiki, event) %>%
    dplyr::tally() %>%
    ggplot(aes(x = event, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of Events", x = "Action Type",
         title = "Number of events by test group and wiki") +
    theme(legend.position = "bottom") + 
    facet_wrap(~ wiki, nrow = n_wiki)
}
```

#### Number of searches
```{r searches_summary, echo=FALSE}
searches %>%
  group_by(`Test group` = group, wiki) %>%
  summarize(`Search sessions` = length(unique(session_id)), `Searches recorded` = n()) %>% ungroup %>% {
    rbind(., tibble(
      `wiki` = "All Wikis",
      `Test group` = "Total",
      `Search sessions` = sum(.$`Search sessions`),
      `Searches recorded` = sum(.$`Searches recorded`)
    ))
  } %>%
  mutate(`Search sessions` = prettyNum(`Search sessions`, big.mark = ","),
         `Searches recorded` = prettyNum(`Searches recorded`, big.mark = ",")) %>%
  knitr::kable()
```

#### Number of searches with *n* same-wiki result(s) returned
```{r n_results_summary, echo=FALSE, fig.height=6*n_wiki}
events %>%
  dplyr::filter(event == "searchResultPage") %>%
  dplyr::mutate(results = dplyr::if_else(n_results >= 5, "5+ results", paste(n_results, "result(s)"))) %>%
  dplyr::group_by(group, results) %>%
  dplyr::summarize(searches = length(unique(serp_id[!is.na(serp_id)]))) %>%
  ggplot(aes(x = results, y = searches, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = searches, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of Searches", x = "Number of Same-Wiki Result(s) Returned",
       title = "Number of searches with n same-wiki result(s) returned, by test group") +
  theme(legend.position = "bottom", strip.placement = "outside")

if (n_wiki > 1){
  events %>%
    dplyr::filter(event == "searchResultPage") %>%
    dplyr::mutate(results = dplyr::if_else(n_results >= 5, "5+ results", paste(n_results, "result(s)"))) %>%
    dplyr::group_by(group, wiki, results) %>%
    dplyr::summarize(searches = length(unique(serp_id[!is.na(serp_id)]))) %>%
    ggplot(aes(x = results, y = searches, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = searches, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of Searches", x = "Number of Same-Wiki Result(s) Returned",
         title = "Number of searches with n same-wiki result(s) returned, by test group and wiki") +
    facet_wrap(~ wiki, nrow = n_wiki) + 
    theme(legend.position = "bottom", strip.placement = "outside")
}
```

`r if(exists("serp_offset")){"#### Number of SERPs by offset"}`
```{r serp_offset_summary, eval = exists("serp_offset"), echo = FALSE, fig.height=6*n_wiki}
serp_offset %>%
  dplyr::mutate(offset = ifelse(offset >= 100, "100+ result(s)", paste(offset, "result(s)"))) %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  dplyr::group_by(group, offset) %>%
  dplyr::tally() %>%
  ggplot(aes(x = offset, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(limits = c(paste(c(0, 20, 40, 60, 80, "100+"), "result(s)"), NA)) + 
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of SERPs", x = "Offset",
       title = "Number of SERPs with n offset, by test group") +
  theme(legend.position = "bottom", strip.placement = "outside")

if (n_wiki > 1){
  serp_offset %>%
    dplyr::mutate(offset = ifelse(offset >= 100, "100+ result(s)", paste(offset, "result(s)"))) %>%
    dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
    dplyr::group_by(group, wiki, offset) %>%
    dplyr::tally() %>%
    ggplot(aes(x = offset, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_x_discrete(limits = c(paste(c(0, 20, 40, 60, 80, "100+"), "result(s)"), NA)) + 
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of SERPs", x = "Offset",
         title = "Number of SERPs with n offset, by test group and wiki") +
    facet_wrap(~ wiki, nrow = n_wiki) + 
    theme(legend.position = "bottom", strip.placement = "outside")
}
```

### Sister Search

`r if(exists("serp_iw")){"#### Number of SERPs' sister-search sidebar results by source and position"}`
```{r serp_iw_summary, eval = exists("serp_iw"), echo = FALSE}
serp_iw %>%
  dplyr::mutate(source = ifelse(is.na(source), "NA", source), 
                position = ifelse(is.na(position), "NA", paste(safe_ordinals(position), "result"))) %>%
  dplyr::group_by(source, position) %>%
  dplyr::summarise(counts = length(unique(event_id))) %>%
  xtabs(counts ~ source + position, data = .) %>%
  addmargins %>%
  knitr::kable()
```

```{r serp_iw_breakdown, eval = exists("serp_iw"), echo = FALSE, fig.width=11, fig.height=6*n_wiki}
serp_iw %>%
  dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
  dplyr::mutate(source = ifelse(is.na(source), "NA", source), 
                position = ifelse(is.na(position), "NA", paste(safe_ordinals(position), "result"))) %>%
  dplyr::group_by(group, source, position) %>%
  dplyr::summarise(counts = length(unique(event_id))) %>%
  ggplot(aes(x = source, y = counts, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = counts, vjust = -0.5), size = 2, 
            position = position_dodge(width = 1)) +
  labs(y = "Number of SERPs", x = "Source",
       title = "Number of SERPs' sister-search sidebar results by source, position and test group") +
  facet_wrap(~ position, scale = "free_y") + 
  theme(legend.position = "bottom", 
        strip.placement = "outside",
        axis.text.x = element_text(angle = 90))

if(n_wiki > 1){
  serp_iw %>%
    dplyr::left_join(events, by = c("session_id", "event_id", "serp_id")) %>%
    dplyr::mutate(source = ifelse(is.na(source), "NA", source), 
                  position = ifelse(is.na(position), "NA", paste(safe_ordinals(position), "result"))) %>%
    dplyr::group_by(group, wiki, source, position) %>%
    dplyr::summarise(counts = length(unique(event_id))) %>%
    ggplot(aes(x = source, y = counts, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = counts, vjust = -0.5), size = 2, 
              position = position_dodge(width = 1)) +
    labs(y = "Number of SERPs", x = "Source",
         title = "Number of SERPs' sister-search sidebar results by source, position, test group and wiki") +
    facet_grid(wiki ~ position, scale = "free_y") + 
    theme(legend.position = "bottom", 
          strip.placement = "outside",
          axis.text.x = element_text(angle = 90))
}
```

`r if(exists("ssclick_des")){"#### Number of sister search clicks by project"}`
```{r ssclick_project, eval = exists("ssclick_des"), echo = FALSE, fig.height=6*n_wiki}
ssclick_des %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  dplyr::group_by(group, project) %>%
  dplyr::tally() %>%
  ggplot(aes(x = project, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of Sister Search Clicks", x = "Project",
       title = "Number of sister search clicks by project and test group") +
  theme(legend.position = "bottom", strip.placement = "outside")

if (n_wiki > 1){
  ssclick_des %>%
    dplyr::left_join(events, by = c("session_id", "event_id")) %>%
    dplyr::group_by(group, wiki, project) %>%
    dplyr::tally() %>%
    ggplot(aes(x = project, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of Sister Search Clicks", x = "Project",
         title = "Number of sister search clicks by project, test group and wiki") +
    facet_wrap(~ wiki, nrow = n_wiki) + 
    theme(legend.position = "bottom", strip.placement = "outside")
}
```

`r if("ssclick" %in% events$event){"#### Number of sister search clicks by position"}`
```{r ssclick_position, eval = "ssclick" %in% events$event, echo = FALSE, fig.height=6*n_wiki}
events %>%
  dplyr::filter(event == "ssclick") %>%
  dplyr::group_by(group, event_position) %>%
  dplyr::tally() %>%
  dplyr::mutate(position = paste(safe_ordinals(event_position), "result")) %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of Sister Search Clicks", x = "Clicked Position",
       title = "Number of sister search clicks by clicked position and test group") +
  theme(legend.position = "bottom", strip.placement = "outside")

if (n_wiki > 1){
  events %>%
    dplyr::filter(event == "ssclick") %>%
    dplyr::group_by(group, wiki, event_position) %>%
    dplyr::tally() %>%
    dplyr::mutate(position = paste(safe_ordinals(event_position), "result")) %>%
    ggplot(aes(x = position, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of Sister Search Clicks", x = "Clicked Position",
         title = "Number of sister search clicks by clicked position, test group and wiki") +
    facet_wrap(~ wiki, nrow = n_wiki) + 
    theme(legend.position = "bottom", strip.placement = "outside")
}
```

`r if("iwclick" %in% events$event){"#### Number of interwiki clicks by position"}`
```{r iwclick_position, eval = "iwclick" %in% events$event, echo = FALSE, fig.height=6*n_wiki}
events %>%
  dplyr::filter(event == "iwclick") %>%
  dplyr::mutate(position = ifelse(event_position < 4, safe_ordinals(event_position + 1), "5th or higher")) %>%
  dplyr::group_by(group, position) %>%
  dplyr::tally() %>%
  ggplot(aes(x = position, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5),
            position = position_dodge(width = 1)) +
  labs(y = "Number of Interwiki Clicks", x = "Clicked Position",
       title = "Number of interwiki clicks by clicked position and test group") +
  theme(legend.position = "bottom", strip.placement = "outside")

if (n_wiki > 1){
  events %>%
    dplyr::filter(event == "iwclick") %>%
    dplyr::mutate(position = ifelse(event_position < 4, safe_ordinals(event_position + 1), "5th or higher")) %>%
    dplyr::group_by(group, wiki, position) %>%
    dplyr::tally() %>%
    ggplot(aes(x = position, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5),
              position = position_dodge(width = 1)) +
    labs(y = "Number of Interwiki Clicks", x = "Clicked Position",
         title = "Number of interwiki clicks by clicked position, test group and wiki") +
    facet_wrap(~ wiki, nrow = n_wiki) + 
    theme(legend.position = "bottom", strip.placement = "outside")
}
```

### Explore Similar

`r if(exists("esclick_result")){"#### Number of explore similar clicks by section and clicked position"}`
```{r esclick_summary, eval = exists("esclick_result"), echo = FALSE}
esclick_result %>%
  dplyr::mutate(section = ifelse(is.na(section), "NA", section), 
                result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))) %>%
  dplyr::group_by(section, result) %>%
  dplyr::tally() %>%
  xtabs(n ~ section + result, data = .) %>%
  addmargins %>%
  knitr::kable()
```

```{r esclick_breakdown, eval = exists("esclick_result"), echo = FALSE, fig.height=6*n_wiki}
esclick_result %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  dplyr::mutate(section = ifelse(is.na(section), "NA", section), 
                result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))) %>%
  dplyr::group_by(group, section, result) %>%
  dplyr::tally() %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5, 
            position = position_dodge(width = 1)) +
  labs(y = "Number of Explore Similar Clicks", x = "Section",
       title = "Number of explore similar clicks by section, clicked position and test group") +
  facet_wrap(~ result, scale = "free_y") + 
  theme(legend.position = "bottom", 
        strip.placement = "outside",
        axis.text.x = element_text(angle = 90))

if (n_wiki > 1){
  esclick_result %>%
    dplyr::left_join(events, by = c("session_id", "event_id")) %>%
    dplyr::mutate(section = ifelse(is.na(section), "NA", section), 
                  result = ifelse(is.na(result), "NA", paste(safe_ordinals(result + 1), "result"))) %>%
    dplyr::group_by(group, wiki, section, result) %>%
    dplyr::tally() %>%
    ggplot(aes(x = section, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5), size = 2.5, 
              position = position_dodge(width = 1)) +
    labs(y = "Number of Explore Similar Clicks", x = "Section",
         title = "Number of explore similar clicks by section, clicked position, test group and wiki") +
    facet_grid(wiki ~ result, scale = "free_y") + 
    theme(legend.position = "bottom", 
          strip.placement = "outside",
          axis.text.x = element_text(angle = 90))
}
```

`r if(exists("hover_over")){"#### Number of hover-over events by section and number of results"}`
```{r hover_summary, eval = exists("hover_over"), echo = FALSE}
hover_over %>%
  dplyr::filter(event == "hover-on") %>%
  dplyr::mutate(results = ifelse(results >= 5, "5+ result(s)", paste(results, "result(s)"))) %>%
  dplyr::group_by(section, results) %>%
  dplyr::tally() %>%
  xtabs(n ~ section + results, data = .) %>%
  addmargins %>% 
  knitr::kable()
```

```{r hover_breakdown, eval = exists("hover_over"), echo = FALSE, fig.width=11, fig.height=6*n_wiki}
hover_over %>%
  dplyr::filter(event == "hover-on") %>%
  dplyr::left_join(events, by = c("session_id", "event_id")) %>%
  dplyr::mutate(section = ifelse(is.na(section), "NA", section), 
                results = ifelse(is.na(results), "NA", ifelse(results >= 5, "5+ result(s)", paste(results, "result(s)")))) %>%
  dplyr::group_by(group, section, results) %>%
  dplyr::tally() %>%
  ggplot(aes(x = section, y = n, fill = group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer("Test Group", palette = "Set1") +
  geom_text(aes(label = n, vjust = -0.5), size = 2.5, 
            position = position_dodge(width = 1)) +
  labs(y = "Number of Hover-Over", x = "Section",
       title = "Number of hover-over events by section, number of results and test group") +
  facet_wrap(~ results, scale = "free_y") + 
  theme(legend.position = "bottom", 
        strip.placement = "outside",
        axis.text.x = element_text(angle = 90))

if (n_wiki > 1){
  hover_over %>%
    dplyr::filter(event == "hover-on") %>%
    dplyr::left_join(events, by = c("session_id", "event_id")) %>%
    dplyr::mutate(section = ifelse(is.na(section), "NA", section), 
                  results = ifelse(is.na(results), "NA", ifelse(results >= 5, "5+ result(s)", paste(results, "result(s)")))) %>%
    dplyr::group_by(group, wiki, section, results) %>%
    dplyr::tally() %>%
    ggplot(aes(x = section, y = n, fill = group)) +
    geom_bar(stat = "identity", position = "dodge") +
    scale_fill_brewer("Test Group", palette = "Set1") +
    geom_text(aes(label = n, vjust = -0.5), size = 2.5, 
              position = position_dodge(width = 1)) +
    labs(y = "Number of Hover-Over", x = "Section",
         title = "Number of hover-over events by section, number of results, test group and wiki") +
    facet_grid(wiki ~ results, scale = "free_y") + 
    theme(legend.position = "bottom", 
          strip.placement = "outside",
          axis.text.x = element_text(angle = 90))
}
```

## Test Metrics

### Same-wiki Zero Results Rate

```{r zrr, echo=FALSE, fig.height=6*n_wiki}
searches %>%
  dplyr::group_by(group) %>%
  dplyr::summarise(zero = sum(!`got same-wiki results`), n_search = n()) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$zero, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "Zero Results Rate",
       title = "Proportion of searches that did not yield any same-wiki results, by test group",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

if (n_wiki > 1){
  searches %>%
    dplyr::group_by(group, wiki) %>%
    dplyr::summarise(zero = sum(!`got same-wiki results`), n_search = n()) %>%
    dplyr::ungroup() %>%
    cbind(
      as.data.frame(binom:::binom.bayes(x = .$zero, n = .$n_search, conf.level = 0.95))
    ) %>%
    ggplot(aes(x = 1, y = mean, color = group)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
    scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    labs(x = NULL, y = "Zero Results Rate",
         title = "Proportion of searches that did not yield any same-wiki results, by test group and wiki",
         subtitle = "With 95% credible intervals.") +
    geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                  y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
    facet_wrap(~ wiki, ncol = 3) +
    theme(legend.position = "bottom",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank())
}
```

### Same-wiki Engagement
```{r engagement_overall, echo=FALSE}
samewiki_ctr_all <- searches %>% # save object samewiki_ctr_all for odds ratio plot
  dplyr::filter(`got same-wiki results` == TRUE) %>%
  dplyr::group_by(group) %>%
  dplyr::summarize(clickthroughs = sum(`same-wiki clickthrough`), n_search = n()) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$clickthroughs, n = .$n_search, conf.level = 0.95))
  )
samewiki_ctr_all %>% 
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "Clickthrough rate",
       title = "Same-wiki clickthrough rates by test group",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
```

```{r engagement_OR_overall, echo=FALSE, results="asis", include=TRUE}
control_group <- grep("control", params$`test_group_names`, value = TRUE)
test_group <- setdiff(params$`test_group_names`, control_group)

for (this_group in test_group){
   cat("**", this_group, " vs. ", control_group, "** \n", sep = "")
   this_plot <- samewiki_ctr_all %>%
     dplyr::filter(group %in% c(control_group, this_group)) %>%
     dplyr::arrange(desc(group)) %>%
     dplyr::do(BCDA::tidy(BCDA::beta_binom(.$x, .$n), interval_type = "HPD")) %>%
     dplyr::ungroup() %>%
     dplyr::mutate(term = factor(
        term,
        levels = c("p2", "p1", "prop_diff", "relative_risk", "odds_ratio"),
        labels = c("Pr[Control Engaging]", "Pr[Test Engaging]", "Pr[Test] - Pr[Control]", "Relative Risk", "Odds Ratio")
     )) %>%
     ggplot(aes(x = 1, y = estimate, ymin = conf.low, ymax = conf.high)) +
     geom_segment(y = 1, yend = 1, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
     geom_segment(y = 0, yend = 0, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
     geom_pointrange() +
     geom_text(aes(label = round(estimate, 4), y = estimate + (conf.high - estimate)/2,
                   hjust = "left"), nudge_x = 0.005) +
     facet_grid(term ~ ., scales = "free_y") +
     scale_x_continuous(limits = c(0.99, 1.05)) +
     theme(legend.position = "bottom",
           panel.grid.major.x = element_blank(),
           panel.grid.minor.x = element_blank(),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           strip.text.y = element_text(size = 12, angle = 0)) +
     labs(x = NULL, y = "Estimate",
          title = "How likely test group users were to engage with search results",
          subtitle = "95% credible intervals calculated as Highest Posterior Density (HPD) intervals")
  print(this_plot)
  cat("\n")
  }
```

```{r engagement_bywiki, echo=FALSE, eval = n_wiki > 1, fig.height=6*n_wiki}
samewiki_ctr_bywiki <- searches %>% # save object samewiki_ctr_bywiki for odds ratio plot
  dplyr::filter(`got same-wiki results` == TRUE) %>%
  dplyr::group_by(group, wiki) %>%
  dplyr::summarize(clickthroughs = sum(`same-wiki clickthrough`), n_search = n()) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$clickthroughs, n = .$n_search, conf.level = 0.95))
  )
samewiki_ctr_bywiki %>% 
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "Clickthrough rate",
       title = "Same-wiki clickthrough rates by test group and wiki",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  facet_wrap(~ wiki, ncol = 3) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())
```

```{r engagement_OR_wiki, eval = n_wiki > 1, echo=FALSE, results="asis", include=TRUE}
control_group <- grep("control", params$`test_group_names`, value = TRUE)
test_group <- setdiff(params$`test_group_names`, control_group)

for (this_group in test_group){
   cat("**", this_group, " vs. ", control_group, " by wiki** \n", sep = "")
   this_plot <- samewiki_ctr_bywiki %>%
     dplyr::filter(group %in% c(control_group, this_group)) %>%
     dplyr::arrange(wiki, desc(group)) %>%
     dplyr::group_by(wiki) %>%
     dplyr::do(BCDA::tidy(BCDA::beta_binom(.$x, .$n), interval_type = "HPD")) %>%
     dplyr::ungroup() %>%
     dplyr::mutate(term = factor(
        term,
        levels = c("p2", "p1", "prop_diff", "relative_risk", "odds_ratio"),
        labels = c("Pr[Control Engaging]", "Pr[Test Engaging]", "Pr[Test] - Pr[Control]", "Relative Risk", "Odds Ratio")
     )) %>%
     ggplot(aes(x = 1, y = estimate, ymin = conf.low, ymax = conf.high)) +
     geom_segment(y = 1, yend = 1, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
     geom_segment(y = 0, yend = 0, x = 0.99, xend = 1.05, linetype = "dashed", color = "gray40") +
     geom_pointrange() +
     geom_text(aes(label = round(estimate, 4), y = estimate + (conf.high - estimate)/2,
                   hjust = "left"), nudge_x = 0.005) +
     facet_grid(term ~ wiki, scales = "free_y") +
     scale_x_continuous(limits = c(0.99, 1.05)) +
     theme(legend.position = "bottom",
           panel.grid.major.x = element_blank(),
           panel.grid.minor.x = element_blank(),
           axis.ticks.x = element_blank(),
           axis.text.x = element_blank(),
           strip.text.y = element_text(size = 12, angle = 0)) +
     labs(x = NULL, y = "Estimate",
          title = "How likely test group users were to engage with search results",
          subtitle = "95% credible intervals calculated as Highest Posterior Density (HPD) intervals")
  print(this_plot)
  cat("\n")
  }
```

### First Clicked Same-Wiki Resultâ€™s Position
```{r first_clicked, echo=FALSE, fig.height=6*n_wiki}
searches %>%
  dplyr::filter(`got same-wiki results` & `same-wiki clickthrough` & !is.na(`first clicked same-wiki results position`)) %>%
  dplyr::mutate(`first clicked result's position` = ifelse(`first clicked same-wiki results position` < 4, safe_ordinals(`first clicked same-wiki results position` + 1), "5th or higher")) %>%
  dplyr::group_by(group, `first clicked result's position`) %>%
  dplyr::tally() %>%
  dplyr::mutate(total = sum(n)) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$n, n = .$total, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(),
                     expand = c(0, 0.005), breaks = seq(0, 1, 0.1)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  facet_wrap(~ `first clicked result's position`, ncol = 5, scale = "free_y") +
  labs(x = NULL, y = "Proportion of searches",
       title = "Position of the first clicked same-wiki result by test group",
       subtitle = "With 95% credible intervals") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

if (n_wiki > 1){
  searches %>%
    dplyr::filter(`got same-wiki results` & `same-wiki clickthrough` & !is.na(`first clicked same-wiki results position`)) %>%
    dplyr::mutate(`first clicked result's position` = ifelse(`first clicked same-wiki results position` < 4, safe_ordinals(`first clicked same-wiki results position` + 1), "5th or higher")) %>%
    dplyr::group_by(group, wiki, `first clicked result's position`) %>%
    dplyr::tally() %>%
    dplyr::mutate(total = sum(n)) %>%
    dplyr::ungroup() %>%
    cbind(
      as.data.frame(binom:::binom.bayes(.$n, n = .$total, conf.level = 0.95))
    ) %>%
    ggplot(aes(x = 1, y = mean, color = group)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
    geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
              position = position_dodge(width = 1)) +
    scale_y_continuous(labels = scales::percent_format(),
                       expand = c(0, 0.005), breaks = seq(0, 1, 0.1)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    facet_wrap(~ wiki + `first clicked result's position`, ncol = 5, scale = "free_y") +
    labs(x = NULL, y = "Proportion of searches",
         title = "Position of the first clicked same-wiki result by test group and wiki",
         subtitle = "With 95% credible intervals") +
    theme(legend.position = "bottom",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank())
}
```

### Maximum Clicked Position for Same-Wiki Results
```{r max_clicked, echo=FALSE, fig.height=6*n_wiki}
searches %>%
  dplyr::filter(`got same-wiki results` & `same-wiki clickthrough` & !is.na(`max clicked position (same-wiki)`)) %>%
  dplyr::mutate(`max clicked position (same-wiki)` = 
                  dplyr::case_when(`max clicked position (same-wiki)` < 4 ~ safe_ordinals(`max clicked position (same-wiki)` + 1),
                                   `max clicked position (same-wiki)` >= 4 & `max clicked position (same-wiki)` < 20 ~ "5th - 20th",
                                   TRUE ~ "21st or higher")) %>%
  dplyr::group_by(group, `max clicked position (same-wiki)`) %>%
  dplyr::summarise(counts = n()) %>%
  dplyr::mutate(total = sum(counts)) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(.$counts, n = .$total, conf.level = 0.95))
  ) %>%
  dplyr::mutate(`max clicked position (same-wiki)` = factor(`max clicked position (same-wiki)`, levels = c("1st", "2nd", "3rd", "4th", "5th - 20th", "21st or higher"))) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
            position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(),
                     expand = c(0, 0.005), breaks = seq(0, 1, 0.1)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  facet_wrap(~ `max clicked position (same-wiki)`, ncol = 6, scale = "free_y") +
  labs(x = NULL, y = "Proportion of searches",
       title = "Maximum clicked position for same-wiki results, by test group",
       subtitle = "With 95% credible intervals") +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

if (n_wiki > 1){
  searches %>%
    dplyr::filter(`got same-wiki results` & `same-wiki clickthrough` & !is.na(`max clicked position (same-wiki)`)) %>%
    dplyr::mutate(`max clicked position (same-wiki)` = 
                    dplyr::case_when(`max clicked position (same-wiki)` < 4 ~ safe_ordinals(`max clicked position (same-wiki)` + 1),
                                     `max clicked position (same-wiki)` >= 4 & `max clicked position (same-wiki)` < 20 ~ "5th - 20th",
                                     TRUE ~ "21st or higher")) %>%
    dplyr::group_by(group, wiki, `max clicked position (same-wiki)`) %>%
    dplyr::summarise(counts = n()) %>%
    dplyr::mutate(total = sum(counts)) %>%
    dplyr::ungroup() %>%
    cbind(
      as.data.frame(binom:::binom.bayes(.$counts, n = .$total, conf.level = 0.95))
    ) %>%
    dplyr::mutate(`max clicked position (same-wiki)` = factor(`max clicked position (same-wiki)`, levels = c("1st", "2nd", "3rd", "4th", "5th - 20th", "21st or higher"))) %>%
    ggplot(aes(x = 1, y = mean, color = group)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
    geom_text(aes(label = sprintf("%.1f", 100 * mean), y = upper + 0.0025, vjust = "bottom"),
              position = position_dodge(width = 1)) +
    scale_y_continuous(labels = scales::percent_format(),
                       expand = c(0, 0.005), breaks = seq(0, 1, 0.1)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    facet_wrap(~ wiki + `max clicked position (same-wiki)`, ncol = 6, scale = "free_y") +
    labs(x = NULL, y = "Proportion of searches",
         title = "Maximum clicked position for same-wiki results, by test group and wiki",
         subtitle = "With 95% credible intervals") +
    theme(legend.position = "bottom",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank())
}
```

### PaulScore
```{r paulscores, echo=FALSE, fig.height=6*ceiling(n_wiki/3)}
searches %>%
  dplyr::ungroup() %>%
  dplyr::filter(`same-wiki clickthrough` == TRUE) %>% 
  dplyr::select(c(group, `Query score (F=0.1)`, `Query score (F=0.5)`, `Query score (F=0.9)`)) %>%
  tidyr::gather(`F value`, `Query score`, -group) %>%
  dplyr::mutate(`F value` = sub("^Query score \\(F=(0\\.[159])\\)$", "F = \\1", `F value`)) %>%
  dplyr::group_by(group, `F value`) %>%
  dplyr::summarize(
    PaulScore = mean(`Query score`),
    Interval = paste0(quantile(bootstrap_mean(`Query score`, 1000), c(0.025, 0.975)), collapse = ",")
  ) %>%
  tidyr::extract(Interval, into = c("Lower", "Upper"), regex = "(.*),(.*)", convert = TRUE) %>%
  ggplot(aes(x = `F value`, y = PaulScore, color = group)) +
  geom_pointrange(aes(ymin = Lower, ymax = Upper), position = position_dodge(width = 0.7)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "PaulScore",
       title = "PaulScore by test group and value of F",
       subtitle = "With bootstrapped 95% confidence intervals.") +
  geom_text(aes(label = sprintf("%.3f", PaulScore), y = Upper + 0.01, vjust = "bottom"),
            position = position_dodge(width = 0.7)) +
  theme(legend.position = "bottom")

if (n_wiki > 1){
  searches %>%
    dplyr::ungroup() %>%
    dplyr::filter(`same-wiki clickthrough` == TRUE) %>% 
    dplyr::select(c(wiki, group, `Query score (F=0.1)`, `Query score (F=0.5)`, `Query score (F=0.9)`)) %>%
    tidyr::gather(`F value`, `Query score`, -c(group, wiki)) %>%
    dplyr::mutate(`F value` = sub("^Query score \\(F=(0\\.[159])\\)$", "F = \\1", `F value`)) %>%
    dplyr::group_by(wiki, group, `F value`) %>%
    dplyr::summarize(
      PaulScore = mean(`Query score`),
      Interval = paste0(quantile(bootstrap_mean(`Query score`, 1000), c(0.025, 0.975)), collapse = ",")
    ) %>%
    tidyr::extract(Interval, into = c("Lower", "Upper"), regex = "(.*),(.*)", convert = TRUE) %>%
    ggplot(aes(x = `F value`, y = PaulScore, color = group)) +
    geom_pointrange(aes(ymin = Lower, ymax = Upper), position = position_dodge(width = 0.7)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    labs(x = NULL, y = "PaulScore",
         title = "PaulScore by wiki, test group and value of F",
         subtitle = "With bootstrapped 95% confidence intervals.") +
    geom_text(aes(label = sprintf("%.3f", PaulScore), y = Upper + 0.01, vjust = "bottom"),
              position = position_dodge(width = 0.7)) +
    facet_wrap(~ wiki, ncol = 3) +
    theme(legend.position = "bottom") 
}
```

`r if(exists("serp_offset")){"### Other Pages of the Search Results"}`
```{r search_offset, eval = exists("serp_offset"), echo = FALSE, fig.height=6*ceiling(n_wiki/3)}
serp_offset %>%
  dplyr::group_by(session_id, serp_id) %>%
  dplyr::summarise(`Any page-turning` = any(offset > 0)) %>%
  dplyr::right_join(searches, by = c("session_id", "serp_id")) %>%
  dplyr::group_by(group) %>%
  dplyr::summarize(page_turn = sum(`Any page-turning`, na.rm = TRUE), n_search = n()) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$page_turn, n = .$n_search, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "Proportion of searches",
       title = "Proportion of searches with clicks to see other pages of the search results, by test group",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

if (n_wiki > 1){
  serp_offset %>%
    dplyr::group_by(session_id, serp_id) %>%
    dplyr::summarise(`Any page-turning` = any(offset > 0)) %>%
    dplyr::right_join(searches, by = c("session_id", "serp_id")) %>%
    dplyr::group_by(group, wiki) %>%
    dplyr::summarize(page_turn = sum(`Any page-turning`, na.rm = TRUE), n_search = n()) %>%
    dplyr::ungroup() %>%
    cbind(
      as.data.frame(binom:::binom.bayes(x = .$page_turn, n = .$n_search, conf.level = 0.95))
    ) %>%
    ggplot(aes(x = 1, y = mean, color = group)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
    scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    labs(x = NULL, y = "Proportion of searches",
         title = "Proportion of searches with clicks to see other pages of the search results, by test group and wiki",
         subtitle = "With 95% credible intervals.") +
    geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                  y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
    facet_wrap(~ wiki, ncol = 3) +
    theme(legend.position = "bottom",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank())
}
```

`r if(exists("visitedPages")){"### Dwell Time per Visited Page"}`
```{r dwelltime, eval=exists("visitedPages"), echo=FALSE, fig.height=6*n_wiki}
temp <- visitedPages
temp$SurvObj <- with(temp, survival::Surv(dwell_time, status == 2))
fit <- survival::survfit(SurvObj ~ group, data = temp)
ggsurv <- survminer::ggsurvplot(fit, conf.int = TRUE, xlab = "T (Dwell Time in seconds)", ylab = "Proportion of visits longer than T (P%)", 
                      surv.scale = "percent", palette = "Set1", legend = "bottom", legend.title = "Test Group", legend.labs = params$test_group_names,
                      ggtheme = theme_bw())
ggsurv$plot + labs(title = "Survival curves by test group", subtitle = "With 95% confidence intervals.")
rm(temp)

if (n_wiki > 1){
  temp <- visitedPages
  temp$SurvObj <- with(temp, survival::Surv(dwell_time, status == 2))
  fit <- survival::survfit(SurvObj ~ group + wiki, data = temp)
  ggsurv <- survminer::ggsurvplot(fit, conf.int = TRUE, xlab = "T (Dwell Time in seconds)", ylab = "Proportion of visits longer than T (P%)", 
                        surv.scale = "percent", palette = "Set1", legend = "bottom", legend.title = "Test Group", legend.labs = params$test_group_names,
                        ggtheme = theme_bw())
  ggsurv$plot + facet_wrap(~ wiki, ncol = 1) + labs(title = "Survival curves by test group and wiki", subtitle = "With 95% confidence intervals.")
  rm(temp)
}
```

`r if(exists("visitedPages")){"### Scroll"}`
```{r scroll, eval=exists("visitedPages"), echo=FALSE, fig.height=6*ceiling(n_wiki/3)}
visitedPages %>%
  dplyr::group_by(group) %>%
  dplyr::summarize(scrolls = sum(scroll), n_visit = n()) %>%
  dplyr::ungroup() %>%
  cbind(
    as.data.frame(binom:::binom.bayes(x = .$scrolls, n = .$n_visit, conf.level = 0.95))
  ) %>%
  ggplot(aes(x = 1, y = mean, color = group)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
  scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
  scale_color_brewer("Test Group", palette = "Set1") +
  labs(x = NULL, y = "Proportion of visits",
       title = "Proportion of visits with scroll by test group",
       subtitle = "With 95% credible intervals.") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
  theme(legend.position = "bottom",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

if (n_wiki > 1){
  visitedPages %>%
    dplyr::group_by(group, wiki) %>%
    dplyr::summarize(scrolls = sum(scroll), n_visit = n()) %>%
    dplyr::ungroup() %>%
    cbind(
      as.data.frame(binom:::binom.bayes(x = .$scrolls, n = .$n_visit, conf.level = 0.95))
    ) %>%
    ggplot(aes(x = 1, y = mean, color = group)) +
    geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width = 1)) +
    scale_y_continuous(labels = scales::percent_format(), expand = c(0.01, 0.01)) +
    scale_color_brewer("Test Group", palette = "Set1") +
    labs(x = NULL, y = "Proportion of visits",
         title = "Proportion of visits with scroll by test group and wiki",
         subtitle = "With 95% credible intervals.") +
    geom_text(aes(label = sprintf("%.2f%%", 100 * mean),
                  y = upper + 0.0025, vjust = "bottom"), position = position_dodge(width = 1)) +
    facet_wrap(~ wiki, ncol = 3) +
    theme(legend.position = "bottom",
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank())
}
```
